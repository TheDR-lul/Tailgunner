# Changelog

## [0.7.0] - 2025-10-23 (FEATURE: Пользовательские паттерны из UI)

### Добавлено
- ✨ **Интеграция UI паттернов с Rust движком** - паттерны из React Flow редактора теперь РЕАЛЬНО РАБОТАЮТ!
- 🔧 **Модуль `ui_patterns.rs`** - конвертация React Flow nodes → Rust триггеры
- 📡 **Tauri команды:** `add_pattern`, `remove_pattern`, `toggle_pattern`
- 🔄 **Автосинхронизация** - паттерны загружаются из localStorage в Rust при старте
- 📊 **Парсинг 11 показателей:** speed, altitude, rpm, temperature, g_load, aoa, ias, tas, mach, fuel, ammo
- 🎵 **Парсинг паттернов вибрации** - конвертация UI кривых в ADSR паттерны
- 📝 **Логирование** на всех уровнях (UI → Rust → Движок)

### Изменено
- 🔕 **Встроенные триггеры отключены по умолчанию** (enabled: false)
- 🔗 **React hooks обновлены** - `addPattern` и `togglePattern` теперь синхронизируются с Rust
- 📦 **Context Provider** загружает все паттерны в Rust при инициализации

### Технические детали
- Новый модуль: `src-tauri/src/ui_patterns.rs` (~200 строк)
- Обновлён: `src/hooks/PatternsProvider.tsx` (+60 строк)
- Новых Tauri команд: 3
- Поддерживаемых показателей: 11
- Поддерживаемых режимов: 3 (once, continuous, repeat)

**Теперь пользовательские паттерны РЕАЛЬНО РАБОТАЮТ!** 🚀

---

## [0.6.1] - 2025-10-23 (CRITICAL BUGFIX: Триггеры не срабатывают!)

### Исправлено
- 🔥 **КРИТИЧЕСКИЙ БАГ**: Триггеры проверяются (`Result: true`), но **НЕ СРАБАТЫВАЮТ**!
- 🐛 **Причина**: Профиль "Легкий Фон (для всех)" содержал паттерны ТОЛЬКО для `Hit` и `CriticalHit`
- ✅ **Решение**: Добавлены паттерны для ВСЕХ 10 встроенных триггеров

### Добавлено в профиль "Легкий Фон"
- ✅ Аэродинамические события: `Overspeed`, `OverG`, `HighAOA`, `CriticalAOA`, `Mach1`
- ✅ Топливо и боезапас: `LowFuel`, `CriticalFuel`, `LowAmmo`
- ✅ Окружение: `LowAltitude`
- ✅ Повреждения: `EngineDamaged`

**Было:** 2 события (0% покрытие триггеров)  
**Стало:** 13 событий (100% покрытие триггеров)

**Теперь триггеры РЕАЛЬНО РАБОТАЮТ!**

---

## [0.6.0] - 2025-10-23 (FEATURE: Управление встроенными триггерами через UI)

### Добавлено
- ✨ **UI компонент для управления триггерами** - новый раздел "Встроенные триггеры"
- 📝 **Описания всех 10 триггеров** - подробное объяснение каждого триггера
- 🔧 **Поле `description`** в структуре `EventTrigger`
- 🏷️ **Поле `is_builtin`** для отличия встроенных триггеров от пользовательских
- ⚡ **Кнопка включения/выключения** для каждого триггера
- 💡 **Визуальная индикация** - включенные триггеры подсвечиваются фиолетовым
- 📊 **Отображение cooldown** для каждого триггера
- 🎨 **Адаптивный дизайн** с hover-эффектами и анимациями
- 📡 **Tauri команды** `get_triggers` и `toggle_trigger`

### Изменено
- 🔗 **Интеграция с HapticEngine** - `trigger_manager` теперь публичный
- 🔄 **Команды используют реальный TriggerManager** из движка
- 📝 **Логирование переключений триггеров** в Debug Console

### Технические детали
- Новый компонент: `src/components/BuiltinTriggers.tsx`
- Стили для триггеров в `src/App.css`
- Обновлён `src-tauri/src/event_triggers.rs` - добавлены описания
- Обновлён `src-tauri/src/haptic_engine.rs` - pub trigger_manager
- Обновлён `src-tauri/src/lib.rs` - команды с интеграцией

**10 встроенных триггеров:**
1. Превышение 800 км/ч (5s cooldown)
2. G-перегрузка >10G (2s cooldown)
3. Угол атаки >15° (3s cooldown)
4. Критический угол атаки >20° (2s cooldown)
5. Mach 1.0 (10s cooldown)
6. Топливо <10% (30s cooldown)
7. Топливо <5% (15s cooldown)
8. Низкая высота <100м (5s cooldown)
9. Перегрев двигателя >250° (10s cooldown)
10. Боезапас <20% (30s cooldown)

---

## [0.5.5.1] - 2025-10-23 (HOTFIX: Логирование триггеров + Сохранение графика)

### Исправлено
- 🐛 **График вибрации сбрасывался** при повторном открытии редактора паттерна - теперь сохраняется
- 🔧 Режим вибрации (once/continuous/repeat) теперь не сбрасывается
- 💾 Все настройки ноды вибрации синхронизируются с data

### Добавлено
- 🔍 **Подробное логирование триггеров** - видно какие проверяются, какие значения, почему не срабатывают
- 📊 Детальное логирование в `evaluate_condition()` - выводятся реальные значения показателей
- 💡 Подсказка в Debug Console о том, где смотреть Rust логи
- ℹ️ Команда для запуска с debug логами: `RUST_LOG=debug npm run tauri dev`
- 🎯 Логирование результатов проверки триггеров (true/false)
- ✅ Логирование успешно сработавших триггеров

**Логи триггеров:**
- `log::trace!` - проверка всех триггеров, cooldown, disabled
- `log::debug!` - условия триггеров, значения показателей, результаты
- `log::info!` - успешно сработавшие триггеры

**Команды для отладки:**
- `npm run tauri dev` - базовые логи (info)
- `RUST_LOG=debug npm run tauri dev` - детальные логи (debug)
- `RUST_LOG=trace npm run tauri dev` - все логи (trace)

---

## [0.5.5] - 2025-10-23 (CRITICAL BUGFIX: Интеграция с WT API v3)

### Исправлено
- 🔥 **КРИТИЧЕСКАЯ ОШИБКА**: Данные из War Thunder не отображались! Все показатели были равны 0
- 🔥 **АРХИТЕКТУРА API**: Исправлено - `/state` содержит ВСЕ данные, не нужен отдельный `/indicators`!
- 🐛 **НАЗВАНИЯ ПОЛЕЙ API**: Исправлены все названия полей в парсере - WT API использует нестандартные названия с запятыми!
- 📡 Интеграция с WT API согласно [официальной документации](https://github.com/lucasvmx/WarThunder-localhost-documentation)
- 💧 **Расчет топлива**: Топливо теперь в кг, рассчитываем процент: `fuel / fuel_max * 100%`
- ⚡ **Скорость**: Больше не умножаем на 3.6, API уже возвращает км/ч

### Добавлено
- 📊 Метод `parse_indicators()` для парсинга JSON с правильными названиями полей
- 🔍 Debug-логирование распарсенных значений (IAS, TAS, высота, топливо)
- 🎯 Поддержка 2 двигателей (берем максимум из RPM 1 и RPM 2)

### Изменено
- 🔄 `get_state()` теперь запрашивает **ОДИН эндпоинт** `/state` (содержит ВСЁ!)
- 🔧 `parse_state()` принимает ОДИН JSON и парсит все indicators из него
- 📝 UI компонент `GameStatus` теперь показывает **реальные данные** в реальном времени
- 🔧 `get_game_status()` теперь правильно рассчитывает процент топлива
- 📊 Логирование в haptic_engine показывает топливо в кг
- ⚡ **Убран лишний запрос** к `/indicators` - всё уже в `/state`!

**Правильные названия полей WT API:**
- Высота: `"H, m"` (не `altitude`)
- Скорость: `"IAS, km/h"`, `"TAS, km/h"` (не `speed`, `IAS`, `TAS`)
- G-перегрузка: `"Ny"` (не `Vy` - это вертикальная скорость!)
- Маха: `"M"` (не `Mach`)
- Топливо: `"Mfuel, kg"`, `"Mfuel0, kg"` (не `fuel`, `fuel_max`)
- Обороты: `"RPM 1"`, `"RPM 2"` (не `RPM`)
- Температура: `"oil temp 1, C"` (с запятыми и единицами!)
- Управление: `"aileron, %"`, `"elevator, %"`, etc.

**Технические детали:**
- Исправлена строка 176 в `wt_telemetry.rs` где создавался пустой `Indicators::default()`
- Добавлены запросы к `/state` и `/indicators` согласно WT API документации
- Парсинг 40+ полей с правильными названиями, включающими запятые, пробелы и единицы измерения

---

## [0.5.4] - 2025-10-23 (BUGFIX: Точность курсора + Режимы вибрации)

### Исправлено
- 🎯 **Точность курсора при зуме** - исправлена проблема несовпадения курсора с позицией точек при масштабировании React Flow
- 🔧 **Синхронизация паттернов** - паттерны теперь сразу появляются в списке после создания (Context Provider)

### Добавлено
- ✨ **Режимы вибрации:**
  - **Разовая** - срабатывает один раз при выполнении условия
  - **Постоянная** - продолжается пока условие выполняется
  - **Циклическая** - повторяется N раз (настраиваемо 1-100)
- 📊 **UI для выбора режима** в ноде вибрации
- 📐 **Подписи осей** на графике вибрации (X = Время, Y = Интенсивность)

### Изменено
- 🎨 **Дефолтная кривая** теперь создается с 2 точками по центру вместо 3
- 🔄 **Context API** для управления паттернами через `PatternsProvider`

**Технические детали:**
- Исправлены `getPointFromEvent()` и `findNearestPoint()` - теперь используют `rect.width/height`
- Создан `PatternsProvider` для единого state управления
- Обновлен `VibrationNodeData` с полями `mode` и `repeatCount`

---

## [0.2.0] - 2025-10-23 (РАСШИРЕНИЕ СОБЫТИЙ)

### Добавлено

#### 🎯 Система событий расширена до 75+ событий
- **Категоризация:** 10 категорий событий
- **Попадания:** Ricochet, HitCamera
- **Повреждения двигателя:** EngineDamaged, EngineOverheat, OilLeak, WaterLeak
- **Экипаж:** PilotKnockedOut, GunnerKnockedOut, DriverKnockedOut
- **Танк:** TurretJammed, GunBreach, TransmissionDamaged, AmmunitionExploded, FuelTankHit
- **Самолет повреждения:** WingDamaged, TailDamaged, ElevatorDamaged, RudderDamaged, AileronDamaged, GearDamaged, FlapsDamaged

#### ✈️ Аэродинамические события (НОВОЕ!)
- **Overspeed** — превышение максимальной скорости (триггер: IAS > 800)
- **OverG** — критическая G-перегрузка (триггер: |G| > 10)
- **HighAOA** — высокий угол атаки (триггер: AOA > 15°)
- **CriticalAOA** — критический угол атаки (триггер: AOA > 20°)
- **Mach1** — преодоление звукового барьера (триггер: Mach > 0.98)
- **FlatSpin** — плоский штопор
- **CompressorStall** — срыв компрессора

#### ⛽ События топлива и боезапаса (НОВОЕ!)
- **LowFuel** — мало топлива (<10%)
- **CriticalFuel** — критически мало (<5%)
- **OutOfFuel** — закончилось топливо
- **LowAmmo** — мало боезапаса (<20%)
- **OutOfAmmo** — закончился боезапас

#### 🌍 События окружения (НОВОЕ!)
- **LowAltitude** — низкая высота (<100м)
- **CriticalAltitude** — критическая высота (<50м)
- **HighAltitude** — большая высота (>5000м)
- **Touchdown** — касание земли
- **Landed** — приземление
- **Takeoff** — взлет

#### 🎯 Система триггеров (event_triggers.rs) - НОВЫЙ МОДУЛЬ!
- **TriggerCondition** enum — условия для кастомных событий
  - SpeedAbove/Below
  - AltitudeAbove/Below
  - GLoadAbove/Below
  - AOAAbove/Below
  - IASAbove, TASAbove, MachAbove
  - FuelBelow, AmmoBelow
  - EngineDamageAbove, ControlsDamageAbove
  - Логические: And, Or, Not
  
- **TriggerManager** — менеджер триггеров
  - 10 встроенных триггеров
  - Cooldown система (предотвращение спама)
  - Поддержка кастомных триггеров

#### 📊 Расширенные Indicators
- **Базовые:** climb (скороподъемность)
- **Двигатель:** manifold_pressure, mixture, radiator, compressor_stage, magneto
- **Управление:** pitch, roll, yaw, aileron, elevator, rudder, airbrake
- **Аэродинамика:** aoa, slip, g_load, mach, tas, ias
- **Вооружение:** cannon_ready, machine_gun_ready, rockets_ready, bombs_ready, torpedoes_ready
- **Боезапас:** ammo_count, rocket_count, bomb_count
- **Топливо:** fuel, fuel_max, fuel_time
- **Повреждения:** engine_damage, controls_damage, gear_damage, flaps_damage

#### 🎮 Новые профили событий
- **Танк RB:** +3 новых события (PenetrationHit, AmmunitionExploded, TrackBroken)
- **Самолет:** +10 новых событий (Overspeed, OverG, HighAOA, CriticalAOA, LowFuel, CriticalFuel, Mach1, и др.)

#### 📚 Документация
- **EVENTS_DOCUMENTATION.md** — полная документация всех 75+ событий
  - Таблицы с описаниями
  - Триггеры для каждого события
  - Примеры использования
  - Ссылки на официальную документацию WT API

### Изменено
- EventEngine расширен для поддержки всех новых событий
- HapticEngine интегрирован с TriggerManager
- ProfileManager обновлен с новыми паттернами

### Технические детали
- Интеграция с [War Thunder localhost API docs](https://github.com/lucasvmx/WarThunder-localhost-documentation)
- Подготовка к интеграции с [WarThunder Vehicles API](https://github.com/Sgambe33/WarThunder-Vehicles-API)
- +300 строк кода в event_triggers.rs
- +150 строк в расширенном маппинге событий

---

## [0.1.0] - 2025-10-23 (MVP)

### Добавлено
- Базовая система событий (15 событий)
- ADSR синтезатор паттернов
- Buttplug.io интеграция
- 3 готовых профиля
- React UI
- Полная документация

---

[0.2.0]: https://github.com/yourusername/butt_thunder/compare/v0.1.0...v0.2.0
[0.1.0]: https://github.com/yourusername/butt_thunder/releases/tag/v0.1.0
