# Butt Thunder - BUGFIX v0.5.4

## 📅 Дата: 23 октября 2025

## 🎯 Исправления

### 1. ✅ Исправлена точность курсора при зуме в редакторе нод

**Проблема:**
- При зуме (приближении/отдалении) в React Flow редакторе курсор не совпадал с реальной позицией точек на графике вибрации
- Появлялась "акселерация" при перетаскивании точек
- Координаты вычислялись неправильно из-за трансформации масштаба

**Решение:**
```typescript
// БЫЛО (в VibrationNode.tsx)
const rect = canvas.getBoundingClientRect();
const x = (e.clientX - rect.left) / canvas.width;  // ❌ Не учитывает масштаб
const y = (e.clientY - rect.top) / canvas.height;

// СТАЛО
const rect = canvas.getBoundingClientRect();
const x = (e.clientX - rect.left) / rect.width;   // ✅ Учитывает реальный размер в браузере
const y = (e.clientY - rect.top) / rect.height;
```

**Изменения:**
- `src/components/nodes/VibrationNode.tsx`:
  - Исправлена функция `getPointFromEvent()` - теперь использует `rect.width/height` вместо `canvas.width/height`
  - Исправлена функция `findNearestPoint()` - аналогичное изменение для определения ближайшей точки

**Эффект:**
- ✅ Курсор теперь **точно совпадает** с позицией точек при любом уровне зума
- ✅ Исчезла "акселерация" - перетаскивание плавное и предсказуемое
- ✅ Работает корректно даже при 200%+ зуме React Flow

---

### 2. ✨ Добавлены режимы вибрации

**Новая функция:**
Теперь каждая вибрация может работать в одном из трех режимов:

#### **Режимы:**

1. **Разовая** (`once`) - *по умолчанию*
   - Вибрация срабатывает **один раз** при выполнении условия
   - Классический режим для событий типа "попадание", "крит"

2. **Постоянная** (`continuous`)
   - Вибрация продолжается **пока выполняется условие**
   - Идеально для:
     - Скорость > 500 км/ч
     - Высота < 100м
     - Перегрузка > 8G
     - Перегрев двигателя
   - Вибрация автоматически останавливается когда условие перестает выполняться

3. **Циклическая** (`repeat`)
   - Вибрация повторяется **N раз**
   - Настраивается количество повторений (1-100)
   - Полезно для создания "пульсации" или "очередей"

#### **Интерфейс:**

```
┌─────────────────────────────────┐
│ 💥 Вибрация                     │
├─────────────────────────────────┤
│ Режим:                          │
│ ┌─────────────────────────────┐ │
│ │ ▼ Разовая                   │ │ ← Dropdown
│ └─────────────────────────────┘ │
│                                 │
│ [Повторений: 3]  ← Только для   │
│                     циклического│
│ ─────────────────────────────── │
│ Длительность (сек): 1.0         │
│ ...                             │
└─────────────────────────────────┘
```

**Изменения:**
- `src/components/nodes/VibrationNode.tsx`:
  - Добавлены поля `mode` и `repeatCount` в `VibrationNodeData`
  - Добавлен state для режима: `const [mode, setMode] = useState<'once' | 'continuous' | 'repeat'>(data.mode || 'once')`
  - Добавлен state для счетчика: `const [repeatCount, setRepeatCount] = useState(data.repeatCount || 3)`
  - Добавлена секция `.mode-controls` с выбором режима
  - Поле "Повторений" появляется только при выборе "Циклическая"

- `src/styles/nodes.css`:
  - Добавлены стили для `.mode-controls`
  - Стилизация select-а в едином стиле с приложением

- `src/components/PatternEditorModal.tsx`:
  - Обновлен `getDefaultNodeData()` для `vibration` - теперь включает `mode: 'once'` и `repeatCount: 3`

**Интеграция:**
> ⚠️ **Примечание:** Логика применения режимов будет реализована в Rust-бэкенде (`haptic_engine.rs`) в следующем обновлении. Сейчас добавлен только UI и сохранение настроек.

---

### 3. 🔧 Исправлена синхронизация паттернов (Context Provider)

**Проблема:**
- Созданные паттерны не появлялись в списке сразу после сохранения
- Компоненты `PatternManager` и `PatternEditorModal` использовали разные экземпляры `usePatterns`
- Состояние не синхронизировалось между компонентами

**Решение:**
Создан `PatternsProvider` - единый Context Provider для управления паттернами.

**Изменения:**
- `src/hooks/PatternsProvider.tsx` (NEW):
  - Создан `PatternsContext` с единым state для всего приложения
  - Все операции (`addPattern`, `updatePattern`, `deletePattern`, `togglePattern`) обновляют один источник истины
  - Автоматическое сохранение в `localStorage` при любых изменениях

- `src/hooks/usePatterns.ts`:
  - Переписан как реэкспорт из `PatternsProvider` для обратной совместимости
  - Теперь возвращает данные из контекста, а не создает новый state

- `src/main.tsx`:
  - Приложение обернуто в `<PatternsProvider>`:
    ```tsx
    <PatternsProvider>
      <App />
    </PatternsProvider>
    ```

**Эффект:**
- ✅ Паттерны **сразу появляются** в списке после создания
- ✅ Изменения **мгновенно синхронизируются** между всеми компонентами
- ✅ Единое место хранения данных - проще отладка
- ✅ В Debug Console теперь отображается: `✅ Pattern created: test (total: 6)`

---

## 📊 Итоги

### Что работает:
✅ Точное позиционирование курсора при любом зуме  
✅ Плавное перетаскивание точек без "акселерации"  
✅ Выбор режима вибрации (Разовая / Постоянная / Циклическая)  
✅ Настройка количества повторений для циклического режима  
✅ Синхронизация паттернов между компонентами через Context API  
✅ Автосохранение паттернов в localStorage  

### Следующие шаги:
🔜 Реализация логики режимов вибрации в Rust (`src-tauri/src/haptic_engine.rs`)  
🔜 Интеграция режимов с системой триггеров  
🔜 Тестирование на реальных устройствах  

---

## 🛠 Технические детали

### Файлы изменены:
- `src/components/nodes/VibrationNode.tsx` - координаты + режимы вибрации
- `src/components/PatternEditorModal.tsx` - дефолтные значения для режимов
- `src/styles/nodes.css` - стили для `.mode-controls`
- `src/hooks/PatternsProvider.tsx` - **НОВЫЙ** - Context Provider для паттернов
- `src/hooks/usePatterns.ts` - реэкспорт из Provider
- `src/main.tsx` - обертка в `PatternsProvider`

### Количество изменений:
- **Строк добавлено:** ~150
- **Строк удалено:** ~90
- **Файлов изменено:** 6
- **Новых файлов:** 1

---

## 🎮 Как использовать новые режимы:

1. **Открой редактор паттернов** (➕ Создать новый)
2. **Добавь ноду "Вибрация"**
3. **В секции "Режим"** выбери:
   - **"Разовая"** - для разовых событий (попадания, крит)
   - **"Постоянная (пока условие)"** - для непрерывных состояний (скорость, высота)
   - **"Циклическая"** - для повторяющихся эффектов (пульсация, очереди)
4. **Для циклической:** укажи количество повторений (1-100)
5. **Сохрани паттерн**

### Примеры использования:

**Пример 1: Разовая вибрация при попадании**
```
[Input: попадание] → [Condition: true] → [Vibration: mode=once, 0.5s] → [Output]
```

**Пример 2: Постоянная вибрация при высокой скорости**
```
[Input: speed] → [Condition: > 700] → [Vibration: mode=continuous, 2.0s] → [Output]
```
*(Вибрация будет продолжаться пока скорость > 700, останавливаясь автоматически при замедлении)*

**Пример 3: Пульсация при критическом состоянии**
```
[Input: fuel] → [Condition: < 10%] → [Vibration: mode=repeat, count=5, 0.3s] → [Output]
```
*(5 коротких вибраций с интервалом 0.3 сек)*

---

## 🐛 Известные ограничения:

- Логика применения режимов в Rust-бэкенде еще не реализована
- Режим "Постоянная" требует доработки системы триггеров для отслеживания состояния условия
- UI для режимов пока на русском, локализация будет добавлена позже

---

**Версия:** v0.5.4  
**Предыдущая версия:** v0.5.3  
**Следующая планируемая версия:** v0.6.0 (реализация режимов в бэкенде)

